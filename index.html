<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MicroPython Block Code Converter</title>
    <script src="https://unpkg.com/blockly@9.0.0/blockly.min.js"></script>
    <script src="https://unpkg.com/blockly@9.0.0/python.js"></script> 
    
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        header {
            padding: 10px 20px;
            background-color: #f0f0f0;
            border-bottom: 1px solid #ccc;
        }
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        #blocklyDiv {
            flex: 2;
            height: 100%;
            min-width: 300px;
        }
        #code-output {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
            background-color: #eee;
            overflow: auto;
        }
        #generated-code {
            flex: 1;
            background-color: #fff;
            padding: 10px;
            border: 1px solid #ccc;
            white-space: pre-wrap;
            overflow: auto;
            font-family: monospace;
        }
    </style>
</head>
<body>

    <header>
        <h1>MicroPython Code Generator (3 Block Demo)</h1>
        <p>Target: **MicroPython** (Simulates micro:bit or ESP32 functionality)</p>
    </header>

    <div id="main-content">
        <div id="blocklyDiv"></div>
        
        <div id="code-output">
            <h2>Generated MicroPython Code</h2>
            <pre id="generated-code">Drag blocks from the 'Core' and 'MicroPython' categories to start!</pre>
        </div>
    </div>

    <script>
        // --- 1. DEFINE CUSTOM BLOCKS (JSON) ---
        // This defines the structure, color, and inputs for the new blocks.
        Blockly.defineBlocksWithJsonArray([
            // MicroPython Block 1: Digital Write
            {
                "type": "micropython_digital_write",
                "message0": "digital write pin %1 to %2",
                "args0": [
                    {
                        "type": "field_dropdown",
                        "name": "PIN",
                        "options": [
                            ["0", "0"], ["1", "1"], ["2", "2"], ["3", "3"]
                        ]
                    },
                    {
                        "type": "field_dropdown",
                        "name": "VALUE",
                        "options": [
                            ["HIGH (1)", "1"], ["LOW (0)", "0"]
                        ]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 120, // Green for hardware control
                "tooltip": "Set a digital pin (e.g., P0) to HIGH or LOW.",
                "helpUrl": ""
            },
            // MicroPython Block 2: Time Delay (Sleep)
            {
                "type": "micropython_sleep_ms",
                "message0": "wait %1 milliseconds",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "TIME",
                        "check": "Number"
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 300, // Purple for time control
                "tooltip": "Pause the program for a set number of milliseconds.",
                "helpUrl": ""
            },
            // MicroPython Block 3: Simple LED Display (micro:bit example)
            {
                "type": "micropython_display_show",
                "message0": "display show %1",
                "args0": [
                    {
                        "type": "input_value",
                        "name": "TEXT",
                        "check": ["String", "Number"]
                    }
                ],
                "previousStatement": null,
                "nextStatement": null,
                "colour": 160,
                "tooltip": "Display text or number on the LED matrix.",
                "helpUrl": ""
            }
        ]);


        // --- 2. DEFINE MICROPYTHON CODE GENERATORS ---
        // We extend the Blockly.Python generator to handle our custom blocks.
        // This is the core conversion logic for your project!
        
        // MicroPython Digital Write Generator
        Blockly.Python['micropython_digital_write'] = function(block) {
            // Ensure machine module is imported at the top of the file
            Blockly.Python.definitions_['import_machine'] = 'from machine import Pin';
            Blockly.Python.definitions_['init_pin_' + block.getFieldValue('PIN')] = 'p' + block.getFieldValue('PIN') + ' = Pin(' + block.getFieldValue('PIN') + ', Pin.OUT)';
            
            var pin = 'p' + block.getFieldValue('PIN');
            var value = block.getFieldValue('VALUE');
            var code = pin + '.value(' + value + ')\n';
            return code;
        };
        
        // MicroPython Time Delay (Sleep) Generator
        Blockly.Python['micropython_sleep_ms'] = function(block) {
            // Ensure time module is imported
            Blockly.Python.definitions_['import_time'] = 'import time';
            
            var time_val = Blockly.Python.valueToCode(block, 'TIME', Blockly.Python.ORDER_NONE) || '100';
            var code = 'time.sleep_ms(' + time_val + ')\n';
            return code;
        };

        // MicroPython Display Show Generator
        Blockly.Python['micropython_display_show'] = function(block) {
            // Ensure microbit module is imported
            Blockly.Python.definitions_['import_microbit'] = 'from microbit import display';
            
            var text = Blockly.Python.valueToCode(block, 'TEXT', Blockly.Python.ORDER_NONE) || "''";
            var code = 'display.show(' + text + ')\n';
            return code;
        };


        // --- 3. TOOLBOX DEFINITION (The Blocks User Sees) ---
        var toolbox = {
          "kind": "categoryToolbox",
          "contents": [
            {
              "kind": "category",
              "name": "Core",
              "colour": 255, // Orange
              "contents": [
                {"kind": "block", "type": "controls_repeat_ext"},
                {"kind": "block", "type": "math_number"},
                {"kind": "block", "type": "text"},
                {"kind": "block", "type": "controls_if"},
                {"kind": "block", "type": "variables_set"},
                {"kind": "block", "type": "variables_get"},
              ]
            },
            {
              "kind": "category",
              "name": "MicroPython Hardware",
              "colour": 120, // Green
              "contents": [
                {"kind": "block", "type": "micropython_digital_write"},
                {"kind": "block", "type": "micropython_sleep_ms"},
                {"kind": "block", "type": "micropython_display_show"},
              ]
            }
            // You would need to create 120 block definitions and generators here!
          ]
        };

        // --- 4. INJECT WORKSPACE AND CONVERSION LOGIC ---
        var workspace = Blockly.inject('blocklyDiv', {
            toolbox: toolbox,
            scrollbars: true,
            trashcan: true,
            media: 'https://unpkg.com/blockly@9.0.0/media/'
        });

        function generateCode() {
            var codeElement = document.getElementById('generated-code');
            
            // This calls the Blockly.Python generator, which now includes our custom MicroPython functions
            var generatedCode = Blockly.Python.workspaceToCode(workspace); 
            
            codeElement.textContent = generatedCode;
        }

        // Real-time Conversion on Workspace Change
        workspace.addChangeListener(function(event) {
             // Only generate code after an actual change, not during internal events
             if (event.isUiEvent || event.type === Blockly.Events.FINISHED_LOADING) {
                 return;
             }
             generateCode();
        });

        // Initial code generation on load
        generateCode();
    </script>
</body>
</html>
